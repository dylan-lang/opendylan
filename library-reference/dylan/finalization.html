
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The finalization Module &mdash; Dylan Library Reference</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/opendylan.org/css/opendylan-docs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="The dylan-primitives Module" href="primitives.html" />
    <link rel="prev" title="The dylan Library" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Dylan Library Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Extensions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language-extensions/index.html">Dylan Language Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lid.html">LID File Format</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../c-ffi/index.html">The c-ffi Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collections/index.html">The collections Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coloring-stream/index.html">The coloring-stream Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common-dylan/index.html">The common-dylan Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dood/index.html">The DOOD library</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The dylan Library</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">The finalization Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-finalization">What is finalization?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-the-finalization-interface-works">How the finalization interface works</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#registering-objects-for-finalization">Registering objects for finalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#draining-the-finalization-queue">Draining the finalization queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finalizers">Finalizers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#after-finalization">After finalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upon-application-exit">Upon application exit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-effects-of-multiple-registrations">The effects of multiple registrations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-effects-of-resurrecting-objects">The effects of resurrecting objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-effects-of-finalizing-objects-directly">The effects of finalizing objects directly</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finalization-and-weak-tables">Finalization and weak tables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-finalizers">Writing finalizers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#class-based-finalization">Class-based finalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parallels-with-initialize-methods">Parallels with INITIALIZE methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simplicity-and-robustness">Simplicity and robustness</a></li>
<li class="toctree-l4"><a class="reference internal" href="#singleton-finalizers">Singleton finalizers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-finalization-in-applications">Using finalization in applications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-can-my-application-drain-the-finalization-queue-automatically">How can my application drain the finalization queue automatically?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#when-should-my-application-drain-the-finalization-queue">When should my application drain the finalization queue?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="primitives.html">The dylan-primitives Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="threads.html">The threads Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../io/index.html">The io Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">The network Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../progress-stream/index.html">The progress-stream Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sql/index.html">The sql Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/index.html">The system Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../t-lists/index.html">The t-lists Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../win32/index.html">The Win32 API Libraries</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Dylan Library Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">The dylan Library</a></li>
      <li class="breadcrumb-item active">The finalization Module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/dylan/finalization.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="the-finalization-module">
<h1>The finalization Module<a class="headerlink" href="#the-finalization-module" title="Permalink to this headline">¶</a></h1>
<p>Open Dylan provides a finalization interface in the <em>finalization</em>
module of <em>common-dylan</em>. This section explains finalization, the
finalization interface provided, and how to use the interface in
applications. Note that you <em>must</em> <code class="docutils literal notranslate"><span class="pre">use</span> <span class="pre">finalization</span></code> to be able
to use the interface described in this documentation.</p>
<div class="section" id="what-is-finalization">
<h2>What is finalization?<a class="headerlink" href="#what-is-finalization" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="http://www.memorymanagement.org">Memory Management Reference</a> defines
finalization as follows:</p>
<blockquote>
<div><p>In garbage-collected languages, it is often necessary to perform actions
on some objects after they are no longer in use and before their memory
can be recycled. These actions are known as finalization or termination.</p>
</div></blockquote>
<p>A common use of finalization is to release a resource when the
corresponding “proxy” object dies, if the proxy object has indefinite
extent and therefore more predictable tools like <code class="docutils literal notranslate"><span class="pre">block</span> <span class="pre">()</span>
<span class="pre">...</span> <span class="pre">cleanup</span> <span class="pre">...</span> <span class="pre">end</span></code> won’t work.</p>
<p>For example, when interfacing Dylan code with foreign code that does
not have automatic memory management, if an interface involves a Dylan
object that references a foreign object it may be necessary to free
the memory resources of the foreign object when the Dylan object is
reclaimed.</p>
</div>
<div class="section" id="how-the-finalization-interface-works">
<h2>How the finalization interface works<a class="headerlink" href="#how-the-finalization-interface-works" title="Permalink to this headline">¶</a></h2>
<p>The following sections give a broad overview of how finalization works
and how to use the interface.</p>
<div class="section" id="registering-objects-for-finalization">
<h3>Registering objects for finalization<a class="headerlink" href="#registering-objects-for-finalization" title="Permalink to this headline">¶</a></h3>
<p>Finalization works through cooperation with the garbage collector.
Objects that are no longer referenced by the application that created
them will eventually be discovered by Dylan’s garbage collector and are
then available to be reclaimed.</p>
<p>By default, the garbage collector reclaims such objects without
notifying your application. If it is necessary to finalize an object
before it is reclaimed, your application must inform the garbage
collector.</p>
<p>The garbage collector maintains a register of objects requiring
finalization before being reclaimed. To add an object to the register,
call the function <a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a> on the object.
Objects on the register are said to be <em>finalizable</em>.</p>
<p>If the garbage collector discovers that a finalizable object is no
longer referenced by the application, it does not reclaim it
immediately. Instead, it takes the object off its finalization register,
and adds it to the <em>finalization queue</em>.</p>
<p>The finalization queue contains all the objects awaiting finalization.
The garbage collector will not reclaim the objects until they have been
finalized.</p>
<p>A simple example of registering a finalizer:</p>
<div class="highlight-dylan notranslate"><div class="highlight"><pre><span></span><span class="k">define</span> <span class="nb">method</span> <span class="nb">initialize</span> <span class="p">(</span><span class="n">lock</span> <span class="p">::</span> <span class="nc">&lt;recursive-lock&gt;</span><span class="p">,</span> <span class="k">#key</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">()</span>
  <span class="n">drain-finalization-queue</span><span class="p">();</span>
  <span class="nb">next-method</span><span class="p">();</span>
  <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">primitive-make-recursive-lock</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span>
                                          <span class="n">lock</span><span class="p">.</span><span class="n">synchronization-name</span><span class="p">);</span>
  <span class="n">check-synchronization-creation</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
  <span class="n">finalize-when-unreachable</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="k">end</span> <span class="nb">method</span><span class="p">;</span>
</pre></div>
</div>
<p>The reasons for calling <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> are discussed below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The library containing this code must have <code class="docutils literal notranslate"><span class="pre">use</span> <span class="pre">finalization;</span></code>
in its module definition.</p>
</div>
</div>
<div class="section" id="draining-the-finalization-queue">
<h3>Draining the finalization queue<a class="headerlink" href="#draining-the-finalization-queue" title="Permalink to this headline">¶</a></h3>
<p>Objects in the finalization queue wait there until the application
drains it by calling the function <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a>. This
function finalizes every object in the queue.</p>
<p>The finalization queue is not normally drained automatically. See
<a class="reference internal" href="#how-can-my-application-drain-the-finalization-queue-automatically">How can my application drain the finalization queue automatically?</a>
for details of how you can set up a thread to do so.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The order in which objects in the finalization queue are
finalized is not defined. Applications should not make any assumptions
about finalization ordering.</p>
</div>
</div>
<div class="section" id="finalizers">
<h3>Finalizers<a class="headerlink" href="#finalizers" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> function
finalizes each object in the finalization queue by calling the generic
function <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on it. You should define
methods for <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on those classes
whose instances may require finalization. These methods are called
<em>finalizers</em>.</p>
<p>The recommended interface to finalization is through
<a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a> and <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a>, but
calling <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on an object directly is also
permitted. If you are certain you are finished with an object, it may be
desirable to do so. For example, you might want to finalize an object
created in a local binding before it goes out of scope.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Finalizable objects are only removed from the register if the
garbage collector discovers that they are unreachable and moves them
into the finalization queue. Calling <em>finalize</em> on an object directly
does not affect its registration status.</p>
</div>
<p>The <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> function
makes each call to <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> inside
whatever dynamic handler environment is present when
<a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> is called. If the call to
<a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> is aborted via a non-local exit during a call
to <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>, the finalization queue retains all the objects that had
been added to it but which had not been passed to <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>.</p>
<p>There is a default method for <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on
<a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>. The method does nothing. It is available so that it is safe
for all finalizers to call <a class="reference external" href="https://opendylan.org/books/drm/Method_Dispatch#HEADING-50-32"><code class="xref drm docutils literal notranslate"><span class="pre">next-method</span></code></a>, a practice that we strongly
encourage. See <a class="reference internal" href="#writing-finalizers">Writing finalizers</a>.</p>
</div>
<div class="section" id="after-finalization">
<h3>After finalization<a class="headerlink" href="#after-finalization" title="Permalink to this headline">¶</a></h3>
<p>Once an object in the finalization queue has been finalized, it
typically becomes available for reclamation by the garbage collector.
Because it has been taken off the garbage collector’s finalization
register, it will not be queued up for finalization again.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are exceptions to this rule; see <a class="reference internal" href="#the-effects-of-multiple-registrations">The effects of
multiple registrations</a> and <a class="reference internal" href="#the-effects-of-resurrecting-objects">The effects of
resurrecting objects</a>.</p>
</div>
</div>
<div class="section" id="upon-application-exit">
<h3>Upon application exit<a class="headerlink" href="#upon-application-exit" title="Permalink to this headline">¶</a></h3>
<p>There are no guarantees that objects which are registered for
finalization will actually be finalized before the application exits.
This is not a problem on many operating systems, which free any
resources held by a process when it exits.</p>
<p>Where it is necessary to guarantee an action at the time the application
exits, you should use a more explicit mechanism.</p>
</div>
<div class="section" id="the-effects-of-multiple-registrations">
<h3>The effects of multiple registrations<a class="headerlink" href="#the-effects-of-multiple-registrations" title="Permalink to this headline">¶</a></h3>
<p>Sometimes objects are registered for finalization more than once. The
effects of multiple registration are defined as follows:</p>
<p>Calling <a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a> on an
object <em>n</em> times causes that object to be added to the finalization
queue up to <em>n</em> times, where <em>n</em> is greater than or equal to zero. There
is no guarantee that the object will be added exactly <em>n</em> times.</p>
<p>Note that this definition so general that it does not guarantee that any
object will ever be added to be finalization queue. In practice, Common
Dylan’s implementation guarantees that an object is added to the queue
at least once whenever an object has ben determined to be unreachable by
the garbage collector.</p>
<p>To remain robust under multiple registration, finalizers should be
idempotent: that is, the effect of multiple <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> calls on an
object should is the same as the effect of a single call.</p>
</div>
<div class="section" id="the-effects-of-resurrecting-objects">
<h3>The effects of resurrecting objects<a class="headerlink" href="#the-effects-of-resurrecting-objects" title="Permalink to this headline">¶</a></h3>
<p>If a finalizer makes an object reachable again, by storing a reference
to the object in a variable, slot, or collection, we say it has
<em>resurrected</em> it. An object may also be resurrected if it becomes
reachable again when some other object is resurrected (because it is
directly or indirectly referenced by that other object).</p>
<p>Resurrecting objects has pitfalls, and must be done with great care.
Since finalizers typically destructively modify objects when freeing
their resources, it is common for finalization to render objects
unusable. We do not recommend resurrection if there is any possibility
of the object being left in an unusable state, or if the object
references any other objects whose transitive closure might include an
object left in such a state by another call to <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>.</p>
<p>If you do resurrect objects, note that they will not be finalized again
unless you re-register them.</p>
</div>
<div class="section" id="the-effects-of-finalizing-objects-directly">
<h3>The effects of finalizing objects directly<a class="headerlink" href="#the-effects-of-finalizing-objects-directly" title="Permalink to this headline">¶</a></h3>
<p>Any object that has been finalized directly, through the application
itself calling <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on it, may not yet be unreachable. Like any
normal object it only becomes eligible for reclamation when it is
unreachable. If such an object was also registered for finalization
using <a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a>, it can end up being finalized again
via the queue mechanism.</p>
</div>
<div class="section" id="finalization-and-weak-tables">
<h3>Finalization and weak tables<a class="headerlink" href="#finalization-and-weak-tables" title="Permalink to this headline">¶</a></h3>
<p>If an object is both registered for finalization and is weakly referred
to from a weak table, finalization occurs <em>first</em>, with weak references
being removed afterwards. That is, reachability is defined in terms of
strong references only, as far as finalization is concerned. Weak
references die only when an object’s storage is finally reclaimed.</p>
<p>For more on weak tables, see <a class="reference internal" href="../language-extensions/weak-tables.html"><span class="doc">Weak tables</span></a>.</p>
</div>
</div>
<div class="section" id="writing-finalizers">
<h2>Writing finalizers<a class="headerlink" href="#writing-finalizers" title="Permalink to this headline">¶</a></h2>
<p>Because the default <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> method, on
<a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>, does nothing, you must define your own
<a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> methods to get results from the
finalization interface. This section contains useful information about
writing finalizers.</p>
<div class="section" id="class-based-finalization">
<h3>Class-based finalization<a class="headerlink" href="#class-based-finalization" title="Permalink to this headline">¶</a></h3>
<p>If your application defines a class for which all instances require
finalization, call <a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a> in its <code class="docutils literal notranslate"><span class="pre">initialize</span></code>
method.</p>
</div>
<div class="section" id="parallels-with-initialize-methods">
<h3>Parallels with INITIALIZE methods<a class="headerlink" href="#parallels-with-initialize-methods" title="Permalink to this headline">¶</a></h3>
<p>The default method on <a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a> is provided to make it safe to call
<a class="reference external" href="https://opendylan.org/books/drm/Method_Dispatch#HEADING-50-32"><code class="xref drm docutils literal notranslate"><span class="pre">next-method</span></code></a> in all finalizers. This situation is parallel to that for
class <a class="reference external" href="https://opendylan.org/books/drm/Constructing_and_Initializing_Instances#initialize"><code class="xref drm docutils literal notranslate"><span class="pre">initialize</span></code></a> methods, which call <code class="docutils literal notranslate"><span class="pre">next-method</span></code> before performing
their own initializations. By doing so, <code class="docutils literal notranslate"><span class="pre">initialize</span></code> methods guarantee
that the most specific initializations occur last.</p>
<p>By contrast, finalizers should call <code class="docutils literal notranslate"><span class="pre">next-method</span></code> last, in case they
depend on the superclass finalizer not being run.</p>
</div>
<div class="section" id="simplicity-and-robustness">
<h3>Simplicity and robustness<a class="headerlink" href="#simplicity-and-robustness" title="Permalink to this headline">¶</a></h3>
<p>Write finalizers that are simple and robust. They might be called in any
context, including within other threads; with careful design, your
finalizers will work in most or all possible situations.</p>
<p>A finalizer might be called on the same object more than once. This
could occur if the object was registered for finalization more than
once, or if your application registered the object for finalization and
also called <code class="docutils literal notranslate"><span class="pre">finalize</span></code> on it directly. To account for this, write
finalizers that are idempotent: that is, the effect of multiple calls is
the same as the effect of a single call. See <a class="reference internal" href="#the-effects-of-multiple-registrations">The effects of
multiple registrations</a> for more on the effects
of multiple registrations.</p>
<p>Remember that the order in which the finalization queue is processed is
not defined. Finalizers cannot make assumptions about ordering.</p>
<p>This is particularly important to note when writing finalizers for
classes that are typically used to form circular or otherwise
interestingly connected graphs of objects. If guarantees about
finalization in graphs of objects are important, we suggest registering
a root object for finalization and making its finalizer traverse the
graph (in some graph-specific well-ordered fashion) and call the
<code class="docutils literal notranslate"><span class="pre">finalize</span></code> method for each object in the graph requiring finalization.</p>
</div>
<div class="section" id="singleton-finalizers">
<h3>Singleton finalizers<a class="headerlink" href="#singleton-finalizers" title="Permalink to this headline">¶</a></h3>
<p>Do not write singleton methods on <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>. The singleton method
itself would refer to the object, and hence prevent it from becoming
unreachable.</p>
</div>
</div>
<div class="section" id="using-finalization-in-applications">
<h2>Using finalization in applications<a class="headerlink" href="#using-finalization-in-applications" title="Permalink to this headline">¶</a></h2>
<p>This section answers questions about using finalization in an
application.</p>
<div class="section" id="how-can-my-application-drain-the-finalization-queue-automatically">
<h3>How can my application drain the finalization queue automatically?<a class="headerlink" href="#how-can-my-application-drain-the-finalization-queue-automatically" title="Permalink to this headline">¶</a></h3>
<p>If you would prefer the queue to be drained asynchronously, use the
automatic finalization interface. For more details, see
<a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a> and
<a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a>.</p>
<p>Libraries that do not wish to depend on automatic finalization should
not use those functions. They should call
<a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> synchronously at
useful times, such as whenever they call <code class="docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code>.</p>
<p>Libraries that are not written to depend on automatic finalization
should always behave correctly if they are used in an application that
does use it.</p>
</div>
<div class="section" id="when-should-my-application-drain-the-finalization-queue">
<h3>When should my application drain the finalization queue?<a class="headerlink" href="#when-should-my-application-drain-the-finalization-queue" title="Permalink to this headline">¶</a></h3>
<p>If you do not use automatic finalization, drain the queue synchronously
at useful points in your application, such as whenever you call
<a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a> on an object.</p>
<p>This section contains a reference description for each item in the
finalization interface. These items are exported from the
<em>common-dylan</em> library in a module called <em>finalization</em>.</p>
<dl class="function">
<dt class="dylan-api" id="common-dylan:finalization:automatic-finalization-enabled?">
<code class="sig-name descname">automatic-finalization-enabled?</code> <em class="property">Function</em><a class="headerlink" href="#common-dylan:finalization:automatic-finalization-enabled?" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns true if automatic finalization is enabled, and false otherwise.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>automatic-finalization-enabled? () =&gt; <em>enabled?</em></p>
</dd>
<dt class="field-even">Values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>enabled?</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Simple_Object_Classes#boolean"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;boolean&gt;</span></code></a>. Default value: <a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#false"><code class="xref drm docutils literal notranslate"><span class="pre">#f</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Discussion</dt>
<dd class="field-odd"><p>Returns true if automatic finalization is enabled, and false otherwise.</p>
</dd>
<dt class="field-even">See also</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt class="dylan-api" id="common-dylan:finalization:automatic-finalization-enabled?-setter">
<code class="sig-name descname">automatic-finalization-enabled?-setter</code> <em class="property">Function</em><a class="headerlink" href="#common-dylan:finalization:automatic-finalization-enabled?-setter" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the automatic finalization system state.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>automatic-finalization-enabled?-setter <em>newval</em> =&gt; ()</p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>newval</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Simple_Object_Classes#boolean"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;boolean&gt;</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Discussion</dt>
<dd class="field-odd"><p><p>Sets the automatic finalization system state to <em>newval</em>.</p>
<p>The initial state is <a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#false"><code class="xref drm docutils literal notranslate"><span class="pre">#f</span></code></a>. If the state changes from <a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#false"><code class="xref drm docutils literal notranslate"><span class="pre">#f</span></code></a> to
<a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#true"><code class="xref drm docutils literal notranslate"><span class="pre">#t</span></code></a>, a new thread is created which regularly calls
<a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a> inside an empty dynamic
environment (that is, no dynamic condition handlers). If the state
changes from <a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#true"><code class="xref drm docutils literal notranslate"><span class="pre">#t</span></code></a> to <a class="reference external" href="https://opendylan.org/books/drm/Other_Built-In_Objects_Defined#false"><code class="xref drm docutils literal notranslate"><span class="pre">#f</span></code></a>, the thread exits.</p>
</p>
</dd>
<dt class="field-even">See also</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt class="dylan-api" id="common-dylan:finalization:drain-finalization-queue">
<code class="sig-name descname">drain-finalization-queue</code> <em class="property">Function</em><a class="headerlink" href="#common-dylan:finalization:drain-finalization-queue" title="Permalink to this definition">¶</a></dt>
<dd><p>Calls <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on every object in the finalization queue.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>drain-finalization-queue () =&gt; ()</p>
</dd>
<dt class="field-even">Discussion</dt>
<dd class="field-even"><p><p>Calls <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on each object that is awaiting finalization.</p>
<p>Each call to <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> is made inside whatever dynamic handler
environment is present when <code class="docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code> is called.
If the call to <code class="docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code> is aborted via a
non-local exit during a call to <code class="docutils literal notranslate"><span class="pre">finalize</span></code>, the finalization
queue retains all the objects that had been added to it but which
had not been passed to <code class="docutils literal notranslate"><span class="pre">finalize</span></code>.</p>
<p>The order in which objects in the finalization queue will be
finalized is not defined. Applications should not make any
assumptions about finalization ordering.</p>
</p>
</dd>
<dt class="field-odd">See also</dt>
<dd class="field-odd"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt class="dylan-api" id="common-dylan:finalization:finalize-when-unreachable">
<code class="sig-name descname">finalize-when-unreachable</code> <em class="property">Function</em><a class="headerlink" href="#common-dylan:finalization:finalize-when-unreachable" title="Permalink to this definition">¶</a></dt>
<dd><p>Registers an object for finalization.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>finalize-when-unreachable <em>object</em> =&gt; <em>object</em></p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>object</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Values</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-even">Discussion</dt>
<dd class="field-even"><p><p>Registers <em>object</em> for finalization. If <em>object</em> becomes
unreachable, it is added to the finalization queue rather than
being immediately reclaimed.</p>
<p><em>Object</em> waits in the finalization queue until the application
calls <a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a>, which processes each object
in the queue by calling the generic function <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a> on it.</p>
<p>The function returns its argument.</p>
</p>
</dd>
<dt class="field-odd">See also</dt>
<dd class="field-odd"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="generic-function">
<dt class="dylan-api" id="common-dylan:finalization:finalize">
<code class="sig-name descname">finalize</code> <em class="property">Generic function</em><a class="headerlink" href="#common-dylan:finalization:finalize" title="Permalink to this definition">¶</a></dt>
<dd><p>Finalizes an object.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>finalize <em>object</em> =&gt; ()</p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>object</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Discussion</dt>
<dd class="field-odd"><p><p>Finalizes <em>object</em>.</p>
<p>You can define methods on <code class="docutils literal notranslate"><span class="pre">finalize</span></code> to perform class-specific
finalization procedures. These methods are called <em>finalizers</em>.</p>
<p>A default <a class="reference internal" href="#common-dylan:finalization:finalize([object])"><code class="xref dylan dylan-meth docutils literal notranslate"><span class="pre">finalize</span></code></a> method on
<a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a> is provided.</p>
<p>The main interface to finalization is the function
<a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a>, which calls <code class="docutils literal notranslate"><span class="pre">finalize</span></code> on each
object awaiting finalization. Objects join the finalization queue
if they become unreachable after being registered for finalization
with <a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a>. However, you can call
<code class="docutils literal notranslate"><span class="pre">finalize</span></code> directly if you wish.</p>
<p>Once finalized, <em>object</em> is available for reclamation by the
garbage collector, unless finalization made it reachable again.
(This is called <em>resurrection</em> ; see <a class="reference internal" href="#the-effects-of-resurrecting-objects">The effects of resurrecting
objects</a>.) Because the object has been taken off the garbage
collector’s finalization register, it will not be added to the
finalization queue again, unless it is resurrected. However, it
might still appear in the queue if it was registered more than
once.</p>
<p>Do not write singleton methods on <a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>. A singleton
method would itself reference the object, and hence prevent it from
becoming unreachable.</p>
</p>
</dd>
<dt class="field-even">See also</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize([object])"><code class="xref dylan dylan-meth docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt class="dylan-api" id="common-dylan:finalization:finalize([object])">
<code class="sig-name descname">finalize(&lt;object&gt;)</code> <em class="property">Method</em><a class="headerlink" href="#common-dylan:finalization:finalize([object])" title="Permalink to this definition">¶</a></dt>
<dd><p>Finalizes an object.</p>
<dl class="field-list simple">
<dt class="field-odd">Signature</dt>
<dd class="field-odd"><p>finalize <em>object</em> =&gt; ()</p>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>object</strong> – An instance of <a class="reference external" href="https://opendylan.org/books/drm/Object_Classes#object"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;object&gt;</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Discussion</dt>
<dd class="field-odd"><p>This method is a default finalizer for all objects. It does nothing, and
is provided only to make <code class="docutils literal notranslate"><span class="pre">next-method</span></code> calls safe for all methods on
<a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a>.</p>
</dd>
<dt class="field-even">See also</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize-when-unreachable"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">finalize-when-unreachable</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:finalize"><code class="xref dylan dylan-gf docutils literal notranslate"><span class="pre">finalize</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:drain-finalization-queue"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">drain-finalization-queue</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?</span></code></a></p></li>
<li><p><a class="reference internal" href="#common-dylan:finalization:automatic-finalization-enabled?-setter"><code class="xref dylan dylan-func docutils literal notranslate"><span class="pre">automatic-finalization-enabled?-setter</span></code></a></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="The dylan Library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="primitives.html" class="btn btn-neutral float-right" title="The dylan-primitives Module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2011-2023, Dylan Hackers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>