# Build runtime library for C backend

srcdir          = @srcdir@
top_srcdir      = @top_srcdir@
top_builddir    = @top_builddir@
GC_CFLAGS       = @GC_CFLAGS@
GC_LFLAGS       = @GC_LFLAGS@

OPEN_DYLAN_PLATFORM_NAME = @OPEN_DYLAN_PLATFORM_NAME@
runtime_srcdir  = $(top_srcdir)/sources/dfmc/c-run-time

subdir          = sources/dfmc/c-run-time

VPATH           = $(srcdir)

LIBDEST         = $(OPEN_DYLAN_USER_INSTALL)/lib
BINDEST         = $(OPEN_DYLAN_USER_INSTALL)/bin
INCDEST         = $(OPEN_DYLAN_USER_INSTALL)/include
OBJDIR          = obj-$(OPEN_DYLAN_PLATFORM_NAME)

CC = @CC@
AS = as -L
AR = ar -q

ifeq ($(OPEN_DYLAN_PLATFORM_NAME),x86-darwin)
	PLATFORM_CFLAGS = -arch i386
endif
ifeq ($(OPEN_DYLAN_PLATFORM_NAME),x86_64-darwin)
	PLATFORM_CFLAGS = -arch x86_64
endif
ifeq ($(OPEN_DYLAN_PLATFORM_NAME),ppc-darwin)
	PLATFORM_CFLAGS = -arch ppc
endif

CFLAGS          = -Wall -DGC_LINUX_THREADS=1 -D_REENTRANT=1 -fPIC \
                  -fno-strict-aliasing \
                  $(PLATFORM_CFLAGS) -O2 -g -I$(srcdir) -I$(runtime_srcdir) \
                  $(GC_CFLAGS)

OBJS    = $(OBJDIR)/posix-threads.o \
          $(OBJDIR)/debug-print.o \
          $(OBJDIR)/run-time.o \
          $(OBJDIR)/trace.o

RUNTIMELIBDEST  = $(LIBDEST)/runtime/c-$(OPEN_DYLAN_PLATFORM_NAME)

all: $(OBJS)

$(OBJDIR)/%.o: $(runtime_srcdir)/%.c
	mkdir -p $(OBJDIR)
	$(CC) $(CFLAGS) -MMD -c -o $@ $<

$(INCDEST):
	mkdir -p $(INCDEST)

$(RUNTIMELIBDEST):
	mkdir -p $(RUNTIMELIBDEST)

install-header: $(runtime_srcdir)/run-time.h $(INCDEST)
	cp -fp $(runtime_srcdir)/trace.h $(INCDEST)
	cp -fp $(runtime_srcdir)/run-time.h $(INCDEST)

install-runtime: $(OBJS) $(RUNTIMELIBDEST)
	cp -fp $(OBJS) $(RUNTIMELIBDEST)

install: install-runtime install-header

clean:
	rm -rf $(OBJDIR)

Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	cd $(top_builddir) && ./config.status $(subdir)/Makefile

-include $(OBJS:%.o=%.d)
