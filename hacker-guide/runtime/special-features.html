
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Special Features &mdash; Open Dylan Hacker&#39;s Guide</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/opendylan.org/css/opendylan-docs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Name Mangling" href="mangling.html" />
    <link rel="prev" title="Calling Convention" href="calling-convention.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Open Dylan Hacker's Guide
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../documentation/index.html">Writing Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build-system.html">Jam-based Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler/index.html">DFMC, The Dylan Flow Machine Compiler</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Runtime</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="object-representation.html">Object Representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="calling-convention.html">Calling Convention</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Special Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="mangling.html">Name Mangling</a></li>
<li class="toctree-l2"><a class="reference internal" href="threads.html">Compiler Support for Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="startup.html">Startup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runtime-manager/index.html">Runtime Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../duim/index.html">DUIM - Dylan User Interface Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/index.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Open Dylan Hacker's Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">The Runtime</a></li>
      <li class="breadcrumb-item active">Special Features</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/runtime/special-features.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="special-features">
<h1>Special Features<a class="headerlink" href="#special-features" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction-to-bind-exit-and-unwind-protect">
<h2>Introduction to bind-exit and unwind-protect<a class="headerlink" href="#introduction-to-bind-exit-and-unwind-protect" title="Permalink to this headline">¶</a></h2>
<p>The following sections describe the implementation for the native code
compiler, only.</p>
<p>Bind-exit and unwind-protect are represented on the stack as frames
which contain information about how to invoke the relevant
continuation. Unwind-protect frames are also chained together, and the
current environment of existing unwind-protects is available in
<code class="docutils literal notranslate"><span class="pre">%current-unwind-protect-frame</span></code>.</p>
<p>There are primitives to build each type of frame, and also to remove
unwind-protect frames (bind-exit frames just have to be popped - so that
is done inline). The primitive which removes unwind-protect frames in
the fall-through case is also responsible for invoking the cleanup code
(which is called as a sub-function in the same function frame as its
parent).</p>
<p>There are also primitives to do non-local exits (<em>NLX</em>). These are
passed the address of the bind-exit frame for the destination, and also
the multiple values to be returned. As part of the NLX, any intervening
unwind-protects are invoked and their frames are removed.
Multiple-values are saved around the unwind-protects in the bind-exit
frame of the destination.</p>
</div>
<div class="section" id="unwind-protect">
<h2>unwind-protect<a class="headerlink" href="#unwind-protect" title="Permalink to this headline">¶</a></h2>
<p>An <em>unwind-protect</em> frame (<em>UPF</em>) looks as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>8</p></td>
<td><p>address of start of cleanup code</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>frame pointer</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>previous unwind-protect frame</p></td>
</tr>
</tbody>
</table>
<p>The compiler compiles unwind-protect as follows:</p>
<div class="highlight-dylan notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">primitive-build-unwind-protect-frame</span><span class="p">(</span><span class="n">tag1</span><span class="p">);</span>
<span class="n">do-the-protected-forms-setting-results-as-for-a-return</span><span class="p">();</span>
<span class="n">primitive-unwind-protect-cleanup</span><span class="p">();</span>
<span class="n">goto</span><span class="p">(</span><span class="n">tag-finished</span><span class="p">);</span>
<span class="k">tag1:</span>
  <span class="n">do-the-cleanup-forms</span><span class="p">();</span>
  <span class="n">end-cleanup</span><span class="p">();</span> <span class="c1">// inlined as a return instruction</span>
<span class="k">tag-finished:</span>
</pre></div>
</div>
<p>If the protected body exits normally, then
<em>primitive-unwind-protect-cleanup</em> is called (in the runtime system).
This causes the unwind-protect frame to be unlinked from the chain, and
the cleanup code to be invoked, as a subroutine call within the same
function frame as the protected body. The cleanup code finishes by
executing a return instruction. The runtime system ensures that any
multiple values are restored, and returns control to the compiled code,
which then executes the code following the unwind-protect.</p>
<p>If the cleanup code is invoked because of an NLX, then the runtime
function finds the ultimate destination <em>bind exit frame</em> (<em>BEF</em>) from
the UPF. The runtime function then passes this BEF to another runtime
function (as for <em>bind-exit)</em> to test whether there are any further
intervening cleanups, or to transfer control to the ultimate destination
if not.</p>
</div>
<div class="section" id="bind-exit">
<h2>bind-exit<a class="headerlink" href="#bind-exit" title="Permalink to this headline">¶</a></h2>
<p>A <em>bind-exit</em> frame (<em>BEF</em>) looks as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>52</p></td>
<td><p>continuation address</p></td>
</tr>
<tr class="row-odd"><td><p>48</p></td>
<td><p>frame pointer</p></td>
</tr>
<tr class="row-even"><td><p>44</p></td>
<td><p>current unwind-protect frame</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>space for stack-allocated
vector for up to 8 multiple
values</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>pointer to saved multiple
values as a vector</p></td>
</tr>
</tbody>
</table>
<p>The compiler compiles bind-exit as follows:</p>
<div class="highlight-dylan notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">primitive-build-bind-exit-frame</span><span class="p">(</span><span class="n">tag1</span><span class="p">);</span>
<span class="k">let</span> <span class="n">closure</span> <span class="o">=</span> <span class="n">make-bind-exit-closure</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
<span class="n">do-the-bind-exit-body-setting-results-as-for-a-return</span><span class="p">();</span>
<span class="k">tag1:</span>
</pre></div>
</div>
<p>During an NLX, multiple-values will be saved in the frame if an
intervening unwind-protect is active. The frame itself contains space
for 8 values. If more values are present, then they will be heap
allocated.</p>
<p>When an NLX occurs, the transfer of control is implemented by a call
into the runtime system, passing the pointer to the BEF as a parameter.
The runtime function first checks whether there is an intervening
cleanup, by testing whether the target dynamic environment in the BEF
matches the current global dynamic environment. If there is no
intervening cleanup, then control is transferred to the destination of
the BEF. Alternatively, if there is an intervening cleanup, then the
ultimate destination field of the current UPF is set to the destination
BEF, and the cleanup code is invoked within a loop which repeatedly
tests for further intervening unwind-protect frames until no more are
found.</p>
</div>
<div class="section" id="multiple-values">
<h2>Multiple Values<a class="headerlink" href="#multiple-values" title="Permalink to this headline">¶</a></h2>
<p>The current implementation of multiple values supports Common Lisp
semantics. It is about to be replaced by a new version which
supports the new Dylan semantics.</p>
<p>Harlequin’s current implementation uses a register to return a single
Dylan value, as this is the only value that is used by almost all
callers. In addition, each function returns a count of the number of
values being returned. This count can be examined by the caller, if
required, to determine how many values were returned. If a function is
returning more than one value, the additional values are stored in a
global (thread-local) area, where the caller may retrieve then, if
desired. On RISC architectures, the multiple value count is returned in
a register. For the x86 architecture, the <em>direction flag</em> register is
set / unset to specify whether single / multiple values are being
returned, respectively. If multiple values are being returned, then the
count of the values is stored in a global (thread-local) location.</p>
<p>Documentation for the new version will be available shortly. Until then,
here’s an overview:</p>
<p>Functions which return a fixed number of return values just return those
values, without returning a count. The first few values will be returned
in registers (an architecture-specific number), and remaining values
will be returned in a thread-local overspill area. If a function always
returns zero values, then no code need be executed to indicate this
fact.</p>
<p>Functions which return a dynamically-sized number of values return their
values as above, but also return a count of the number being returned in
a register. If a function dynamically happens to return zero values,
then the return count will be set to zero, but the value <em>#f</em> will be
returned as if it were the first return value.</p>
<p>If the caller of a function can statically determine the number of
return values (i.e. at compile-time), then it need perform no checks.
However, if the caller has no knowledge of the function being called,
then it must check the properties of the callee function object to
determine whether the static or dynamic convention is being used, and
may then need to read either the dynamic return value count, or the
static count in the properties of the function object.</p>
<p>This design has some interesting implications for tail-call
optimization. A function can simply tail another function only if both
the following rules apply:</p>
<ol class="arabic simple">
<li><p>The callee is known to return at least as many values as the caller,
and they have appropriate types.</p></li>
<li><p>If the caller returns a dynamically-sized number of values, then the
callee must too.</p></li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="calling-convention.html" class="btn btn-neutral float-left" title="Calling Convention" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mangling.html" class="btn btn-neutral float-right" title="Name Mangling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2011-2023, Dylan Hackers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>