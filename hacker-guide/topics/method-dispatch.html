
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Method Dispatch &mdash; Open Dylan Hacker&#39;s Guide</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/opendylan.org/css/opendylan-docs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Debugging" href="debugging.html" />
    <link rel="prev" title="Topics" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Open Dylan Hacker's Guide
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../documentation/index.html">Writing Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build-system.html">Jam-based Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compiler/index.html">DFMC, The Dylan Flow Machine Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runtime/index.html">The Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runtime-manager/index.html">Runtime Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../duim/index.html">DUIM - Dylan User Interface Manager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Topics</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Method Dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="porting.html">Porting to a New Target Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppml.html">The PPML library</a></li>
<li class="toctree-l2"><a class="reference internal" href="making-a-release.html">Release Check-list</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Open Dylan Hacker's Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Topics</a></li>
      <li class="breadcrumb-item active">Method Dispatch</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/topics/method-dispatch.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="method-dispatch">
<h1>Method Dispatch<a class="headerlink" href="#method-dispatch" title="Permalink to this headline">¶</a></h1>
<p>Method dispatch is a critical area for compile time and runtime optimization
in Dylan. Since nearly everything appears to involve a method dispatch including
slot access, it is very important that the compiler be able to optimize much
of this away.</p>
<p>Method dispatch has support in both the compiler and the runtime. The runtime
portion also has data structures that are defined in the compiler (leading to
dependencies between the compiler and the runtime).</p>
<p>Runtime portions, including compiler support, can be found in these files:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/discrimination.dylan">sources/dylan/discrimination.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/dispatch-caches.dylan">sources/dylan/dispatch-caches.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/dispatch-prologue.dylan">sources/dylan/dispatch-prologue.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/dispatch.dylan">sources/dylan/dispatch.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/new-dispatch.dylan">sources/dylan/new-dispatch.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/slot-dispatch.dylan">sources/dylan/slot-dispatch.dylan</a></p></li>
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/modeling/functions.dylan">sources/dfmc/modeling/functions.dylan</a></p></li>
</ul>
<p>Compiler support for method dispatch optimization can be found in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/optimization/dispatch.dylan">sources/dfmc/optimization/dispatch.dylan</a></p></li>
</ul>
<div class="section" id="publications">
<h2>Publications<a class="headerlink" href="#publications" title="Permalink to this headline">¶</a></h2>
<p>One paper has been written about the implementation of dispatch in Open Dylan:</p>
<ul class="simple">
<li><p><strong>Partial Dispatch: Optimizing Dynamically-Dispatched Multimethod Calls with Compile-Time Types and Runtime Feedback</strong> (by Jonathan Bachrach and Glenn Burke - Technical Report 2000 <a class="reference external" href="http://people.csail.mit.edu/jrb/Projects/pd.pdf">pdf</a>)</p></li>
</ul>
</div>
<div class="section" id="generic-function-representation">
<h2>Generic Function Representation<a class="headerlink" href="#generic-function-representation" title="Permalink to this headline">¶</a></h2>
<p>In Dylan, a generic function looks like (from
<a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/modeling/functions.dylan">sources/dfmc/modeling/functions.dylan</a>):</p>
<div class="highlight-dylan notranslate"><div class="highlight"><pre><span></span><span class="k">define</span> <span class="nb">abstract</span> <span class="nb">primary</span> <span class="n">&amp;class</span> <span class="nc">&lt;generic-function&gt;</span> <span class="p">(</span><span class="nc">&lt;function&gt;</span><span class="p">)</span>
  <span class="n">lazy</span> <span class="n">&amp;slot</span> <span class="n">function-signature</span> <span class="p">::</span> <span class="n">false-at-compile-time-or</span><span class="p">(</span><span class="nc">&lt;signature&gt;</span><span class="p">),</span>
    <span class="k">init-value:</span> <span class="l">#f</span><span class="p">,</span>
    <span class="k">init-keyword:</span> <span class="k">signature:</span><span class="p">;</span>
  <span class="n">&amp;slot</span> <span class="n">%gf-cache</span><span class="p">,</span> <span class="k">init-value:</span> <span class="l">#f</span><span class="p">;</span>
  <span class="n">lazy</span> <span class="n">&amp;slot</span> <span class="n">debug-name</span> <span class="p">::</span> <span class="nc">&lt;object&gt;</span><span class="p">,</span>
    <span class="k">init-value:</span>   <span class="l">#f</span><span class="p">,</span>
    <span class="k">init-keyword:</span> <span class="k">debug-name:</span><span class="p">;</span>
  <span class="n">lazy</span> <span class="n">&amp;computed-slot</span> <span class="nb">generic-function-methods</span> <span class="p">::</span> <span class="nc">&lt;list&gt;</span><span class="p">,</span>
    <span class="k">init-value:</span> <span class="p">#();</span>
  <span class="c1">// If we start using this it should probably be made lazy, as it would</span>
  <span class="c1">// only be used for creating the runtime object, not compilation.</span>
  <span class="n">&amp;slot</span> <span class="n">discriminator</span><span class="p">,</span> <span class="k">init-value:</span> <span class="l">#f</span><span class="p">;</span>

  <span class="c1">// Compile-time slots.</span>
  <span class="nb">slot</span> <span class="n">^generic-function-properties</span> <span class="p">::</span> <span class="nc">&lt;integer&gt;</span><span class="p">,</span> <span class="k">init-value:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">lazy</span> <span class="nb">slot</span> <span class="n">signature-spec</span> <span class="p">::</span> <span class="nc">&lt;signature-spec&gt;</span><span class="p">,</span>
    <span class="k">required-init-keyword:</span> <span class="k">signature-spec:</span><span class="p">;</span>
  <span class="n">lazy</span> <span class="nb">slot</span> <span class="n">%generic-function-domains</span> <span class="p">::</span> <span class="nc">&lt;list&gt;</span> <span class="o">=</span> <span class="p">#();</span>
  <span class="nb">slot</span> <span class="n">parameters-dynamic-extent</span><span class="p">,</span>
        <span class="k">init-value:</span> <span class="l">#f</span><span class="p">,</span>
    <span class="k">init-keyword:</span> <span class="k">dynamic-extent:</span><span class="p">;</span>
  <span class="nb">slot</span> <span class="n">^generic-function-cache-info</span> <span class="o">=</span> <span class="l">#f</span><span class="p">;</span>
  <span class="n">metaclass</span> <span class="nc">&lt;function-class&gt;</span><span class="p">;</span>
<span class="k">end</span> <span class="n">&amp;class</span> <span class="nc">&lt;generic-function&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>There are 2 subclasses of <a class="reference external" href="https://opendylan.org/books/drm/Function_Classes#generic-function"><code class="xref drm docutils literal notranslate"><span class="pre">&lt;generic-function&gt;</span></code></a>: <code class="docutils literal notranslate"><span class="pre">&lt;sealed-generic-function&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">&lt;incremental-generic-function&gt;</span></code>.  A sealed generic function adds no slots, while
an incremental generic function maintains some extra data to support adding further
methods.</p>
<p>At the moment, we’ll focus on sealed generic functions.</p>
<p>And in the generated C, a sealed generic function looks like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">D</span> <span class="n">wrapper</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">xep_</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">function_signature_</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">Pgf_cache_</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">debug_name_</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">generic_function_methods_</span><span class="p">;</span>
  <span class="n">D</span> <span class="n">discriminator_</span><span class="p">;</span>
<span class="p">}</span> <span class="n">_KLsealed_generic_functionGVKe</span><span class="p">;</span>

<span class="n">_KLsealed_generic_functionGVKe</span> <span class="n">Ksize_in_wordsVKi</span> <span class="o">=</span> <span class="p">{</span>
  <span class="o">&amp;</span><span class="n">KLsealed_generic_functionGVKeW</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">gf_xep_1</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">KDsignature_LobjectG_object_rest_value_1VKi</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">KPfalseVKi</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">K342</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">K632</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">RSINGULAR_Labsent_engine_nodeG</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Incremental generic functions look similar, but contain some additional data
after the discriminator.</p>
<p>The types in the generated C are just <code class="docutils literal notranslate"><span class="pre">D</span></code> which is what the Dylan
compiler’s C back-end likes to generate. More specific types for some
values are available but not emitted by the C back-end. (Improvements
in this area are worth considering as they would improve the debugging
experience.)</p>
</div>
<div class="section" id="runtime-dispatch">
<h2>Runtime Dispatch<a class="headerlink" href="#runtime-dispatch" title="Permalink to this headline">¶</a></h2>
<p>Much of the technical report by Bachrach and Burke remains accurate with
respect to the basics of dispatch.</p>
<div class="section" id="discriminators-at-runtime">
<h3>Discriminators at Runtime<a class="headerlink" href="#discriminators-at-runtime" title="Permalink to this headline">¶</a></h3>
<p>The initial discriminator of a generic function is <code class="docutils literal notranslate"><span class="pre">$absent-engine-node</span></code>
(or in C, <code class="docutils literal notranslate"><span class="pre">RSINGULAR_absent_engine_node</span></code>). When this is encountered when
performing a dispatch, <code class="docutils literal notranslate"><span class="pre">gf-dispatch-absent</span></code> is invoked, which calls
<code class="docutils literal notranslate"><span class="pre">handle-missed-dispatch</span></code>. The initial dispatch engine state will then
be calculated in <code class="docutils literal notranslate"><span class="pre">calculate-dispatch-engine</span></code> and dispatch will proceed.</p>
<p>In this way, dispatch data is built incrementally at runtime as it is
needed and can take advantage of data available at runtime. In fact,
dispatch can start out being monomorphic and grow to linear and then
hash-based discriminators as the number of relevant methods changes
at runtime.</p>
<p>For example, when growing a linear discriminator (<code class="docutils literal notranslate"><span class="pre">grow-linear-class-keyed-discriminator</span></code>),
it can be upgraded to become a hashed discriminator.</p>
<p>The logic for creating a new discriminator starts in <code class="docutils literal notranslate"><span class="pre">compute-discriminator-for-arg</span></code>
(defined in <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/discrimination.dylan">sources/dylan/discrimination.dylan</a>).</p>
</div>
<div class="section" id="discriminator-structure">
<h3>Discriminator Structure<a class="headerlink" href="#discriminator-structure" title="Permalink to this headline">¶</a></h3>
<p>The classes that dictate the in-memory layout of the discriminators are
defined within the compiler in <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/modeling/functions.dylan">sources/dfmc/modeling/functions.dylan</a>.</p>
<p>Of particular interest are the <code class="docutils literal notranslate"><span class="pre">&lt;linear-by-class-discriminator&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">&lt;hashed-by-class-discriminator&gt;</span></code>. These, along with some variants
for dealing with singleton dispatch, define a repeated slot for storing
their data:</p>
<div class="highlight-dylan notranslate"><div class="highlight"><pre><span></span><span class="n">repeated</span> <span class="n">&amp;slot</span> <span class="n">class-keyed-discriminator-table-element</span><span class="p">,</span>
  <span class="k">init-value:</span>        <span class="l">#f</span><span class="p">,</span>
  <span class="k">size-getter:</span>       <span class="n">class-keyed-discriminator-table-size</span><span class="p">,</span>
  <span class="k">size-init-keyword:</span> <span class="k">size:</span><span class="p">,</span>
  <span class="k">size-init-value:</span>   <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>For these discriminators, the keys and values are stored in alternating
sequence:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key1</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span>
</pre></div>
</div>
<p>This allows for a compact representation within memory without extra
allocations for pairs of values, a hash table, etc.</p>
<p>The code for iterating over this data can be found in the functions
<code class="docutils literal notranslate"><span class="pre">linear-class-key-lookup</span></code> and <code class="docutils literal notranslate"><span class="pre">hashed-class-key-lookup</span></code> as found
within <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dylan/new-dispatch.dylan">sources/dylan/new-dispatch.dylan</a>. That file also contains
the code for adding new methods to the discriminator.</p>
</div>
</div>
<div class="section" id="compile-time-optimization">
<h2>Compile Time Optimization<a class="headerlink" href="#compile-time-optimization" title="Permalink to this headline">¶</a></h2>
<p><em>Discuss the impact of sealing and other things here.</em></p>
</div>
<div class="section" id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="performance-highlighting">
<h3>Performance Highlighting<a class="headerlink" href="#performance-highlighting" title="Permalink to this headline">¶</a></h3>
<p>The compiler records dispatch decisions as they’re made within
the optimizer. This work is performed within <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/optimization/dispatch.dylan">sources/dfmc/optimization/dispatch.dylan</a>
(look for calls to <code class="docutils literal notranslate"><span class="pre">color-dispatch</span></code>). It is worth noting
that the dispatch decisions are compacted by <code class="docutils literal notranslate"><span class="pre">compact-coloring-info</span></code>
in <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/dfmc/management/compilation-driver.dylan">sources/dfmc/management/compilation-driver.dylan</a>.</p>
<p>In the IDE, Open Dylan supports performance highlighting to indicate how
much optimization the compiler was able to apply. This is performed
within <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/environment/deuce/dylanworks-mode.dylan">sources/environment/deuce/dylanworks-mode.dylan</a> by examining
the results from <code class="docutils literal notranslate"><span class="pre">source-record-colorization-info</span></code>.</p>
<p>This information is also available in <code class="docutils literal notranslate"><span class="pre">.el</span></code> files within the build
directory that can be used with the <code class="docutils literal notranslate"><span class="pre">dylan-mode</span></code> in emacs. The
generation of the <code class="docutils literal notranslate"><span class="pre">.el</span></code> files is performed by <code class="docutils literal notranslate"><span class="pre">project-dump-emacs-dispatch-colors</span></code>
in <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/project-manager/projects/implementation.dylan">sources/project-manager/projects/implementation.dylan</a>.</p>
<p>The available dispatch decisions that are recorded for highlighting
are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;not-all-methods-known&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;failed-to-select-where-all-known&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;lambda-call&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;inlining&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;slot-accessor-fixed-offset&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;eliminated&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;dynamic-extent&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#&quot;bogus-upgrade&quot;</span></code></p></li>
</ul>
<p><em>Link to documentation on both of these features, perhaps embed
some screenshots.</em></p>
</div>
<div class="section" id="dispatch-profiler">
<h3>Dispatch Profiler<a class="headerlink" href="#dispatch-profiler" title="Permalink to this headline">¶</a></h3>
<p>There is a dispatch profiler in <a class="reference external" href="https://github.com/dylan-lang/opendylan/tree/master/sources/lib/dispatch-profiler">sources/lib/dispatch-profiler</a>
but no one knows how to use it.</p>
</div>
</div>
<div class="section" id="future-work">
<h2>Future Work<a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Learn more about partial dispatch and possibly enable it.</p></li>
<li><p>Look at the effectiveness of call site caching.</p></li>
<li><p>Can the hashing in the megamorphic hashed by-class discriminator
be tuned better?</p></li>
<li><p>Learn more about and document things mentioned in this document
but that aren’t understood well (like dispatch profiling).</p></li>
<li><p>Much more documentation.</p></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Topics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debugging.html" class="btn btn-neutral float-right" title="Debugging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> 2011-2023, Dylan Hackers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>